<div class="container py-3" style="max-width: 500px;">
    <h4 class="text-center text-primary mb-3">Conteo de Inventario</h4>

    <!-- üì∑ ESCANEO EN TIEMPO REAL -->
    <div class="card shadow-sm p-3 mb-3 bg-white rounded">
        <h5 class="text-center">Escaneo en vivo</h5>
        <div class="text-center" id="videoContainer">
            <video id="video" class="rounded border border-primary shadow-sm" width="100%" height="auto"
                autoplay></video>
        </div>
        <p id="result" class="alert alert-info text-center mt-2">Esperando escaneo...</p>
    </div>

    <!-- üì∏ ESCANEO DESDE IMAGEN -->
    <div class="card shadow-sm p-3 bg-white rounded">
        <h5 class="text-center">Subir imagen</h5>
        <input type="file" id="fileInput" class="form-control mb-2" accept="image/*">
        <img id="imagenCodigo" class="d-none mx-auto img-thumbnail shadow-sm" style="max-width: 100%;">
        <p id="imageResult" class="alert alert-secondary text-center mt-2">Esperando escaneo...</p>
    </div>

    <!-- üìä RESULTADOS DEL CONTEO -->
    <div class="card shadow-sm p-3 mt-3 bg-light">
        <h5 class="text-center">Conteo de productos</h5>
        <ul id="listaConteo" class="list-group"></ul>
        <button class="btn btn-success w-100 mt-2" onclick="finalizarConteo()">Finalizar conteo</button>
        <button id="btnActualizarInventario" style="display: none;" onclick="actualizarInventario()">Actualizar
            Inventario</button>
    </div>
</div>

<script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm';

    const codeReader = new BrowserMultiFormatReader();
    const videoElement = document.getElementById('video');
    const resultElement = document.getElementById('result');
    const listaConteo = document.getElementById('listaConteo');
    let conteoTemporal = {};
    let lastScanTime = 0;

    // EXTRAER CODIGO DAMATRIX

    function extraerDatos(codigoMatrix) {
        // Expresiones regulares mejoradas
        const codigoBarrasMatch = codigoMatrix.match(/\(01\)(.+?)(?=\(11\)|\(17\)|\(10\)|$)/);
        const fechaProduccionMatch = codigoMatrix.match(/\(11\)(\d{6})/);
        const fechaExpiracionMatch = codigoMatrix.match(/\(17\)(\d{6})/);
        const loteMatch = codigoMatrix.match(/\(10\)(.+)$/);

        // Extraer los datos con valores por defecto si no se encuentran
        const codigoBarras = codigoBarrasMatch ? codigoBarrasMatch[1].trim() : 'Desconocido';
        const fechaProduccion = fechaProduccionMatch ? formatearFecha(fechaProduccionMatch[1]) : 'Sin fecha';
        const fechaExpiracion = fechaExpiracionMatch ? formatearFecha(fechaExpiracionMatch[1]) : 'Sin fecha';
        const lote = loteMatch ? loteMatch[1] : 'Sin lote';

        // Retornar datos extra√≠dos
        return {
            codigoBarras,
            fechaProduccion,
            fechaExpiracion,
            lote
        };
    }

    // Funci√≥n para formatear la fecha de YYMMDD a YYYY-MM-DD
    function formatearFecha(fechaYYMMDD) {
        const a√±o = "20" + fechaYYMMDD.substring(0, 2);
        const mes = fechaYYMMDD.substring(2, 4);
        const dia = fechaYYMMDD.substring(4, 6);
        return `${a√±o}-${mes}-${dia}`;
    }

    async function startVideoScanner() {
        try {
            await codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
                if (result) {
                    const now = Date.now();
                    if (now - lastScanTime > 2000) {
                        lastScanTime = now;
                        procesarCodigoEscaneado(result.text, resultElement);
                    }
                }
            });
        } catch (error) {
            console.error("Error al acceder a la c√°mara:", error);
        }
    }

    // üì∏ ESCANEO DESDE IMAGEN
    document.getElementById('fileInput').addEventListener('change', async function (event) {
        // Detener la c√°mara antes de escanear im√°genes
        codeReader.reset();
        if (videoElement.srcObject) {
            let tracks = videoElement.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            videoElement.srcObject = null;
        }

        const file = event.target.files[0];
        if (!file) return;

        const imgElement = document.getElementById('imagenCodigo');
        imgElement.src = URL.createObjectURL(file);
        imgElement.classList.remove("d-none");

        try {
            const result = await codeReader.decodeFromImage(imgElement);
            procesarCodigoEscaneado(result.text, document.getElementById('imageResult'));
            event.target.value = ""; // Permitir escanear la misma imagen otra vez
        } catch (err) {
            console.error("Error al escanear (imagen):", err);
        } finally {
            // Reiniciar la c√°mara despu√©s del escaneo de la imagen
            setTimeout(startVideoScanner, 500);
        }
    });

    startVideoScanner();

    function reproducirSonido() {
        const sonido = new Audio('/img/beep.mp3'); // Ruta del sonido
        sonido.play().catch(error => console.error("Error al reproducir sonido:", error));
    }

    // üì§ PROCESAR Y ENVIAR C√ìDIGO
    async function procesarCodigoEscaneado(codigo, element) {
        const datos = extraerDatos(codigo); // Aseg√∫rate de que devuelve un objeto

        // Validar si el c√≥digo de barras y el lote existen
        if (!datos || !datos.codigoBarras || !datos.lote) {
            element.textContent = "‚ö†Ô∏è C√≥digo inv√°lido o sin datos completos.";
            element.classList.replace("alert-info", "alert-danger");
            return;
        }

        // Mostrar el c√≥digo escaneado en pantalla
        element.textContent = `üì¶ C√≥digo: ${datos.codigoBarras} | Producci√≥n: ${datos.fechaProduccion} | Expiraci√≥n: ${datos.fechaExpiracion} | üè∑Ô∏è Lote: ${datos.lote}`;
        element.classList.replace("alert-info", "alert-success");
        element.classList.replace("alert-secondary", "alert-success");

        // üîä Reproducir sonido cuando el c√≥digo es v√°lido
        reproducirSonido();

        // Generar clave √∫nica para el conteo
        const clave = `${datos.codigoBarras} | ${datos.lote}`;
        conteoTemporal[clave] = (conteoTemporal[clave] || 0) + 1;
        actualizarListaConteo();

        try {
            const response = await fetch('/products/api/contar-productos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codigos: Object.keys(conteoTemporal) })
            });

            const data = await response.json();
            if (!data.success) {
                alert(`‚ö†Ô∏è Error: ${data.mensaje}`);
            }
        } catch (error) {
            console.error("‚ùå Error al enviar c√≥digo al servidor:", error);
        }
    }

    // üîÑ ACTUALIZAR LISTA DE CONTEO EN PANTALLA
    function actualizarListaConteo() {
        listaConteo.innerHTML = "";
        Object.entries(conteoTemporal).forEach(([codigo, cantidad]) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `<span>üì¶ ${codigo}</span> <span class="badge bg-primary">${cantidad}</span>`;
            listaConteo.appendChild(li);
        });
    }


    // üìä FINALIZAR CONTEO Y OBTENER DIFERENCIAS
    async function finalizarConteo() {
        if (Object.keys(conteoTemporal).length === 0) {
            alert("‚ö†Ô∏è No hay productos escaneados.");
            return;
        }

        try {
            const response = await fetch('/products/api/finalizar-conteo', {
                method: 'POST',
            });

            const data = await response.json();
            if (data.success) {
                alert("‚úÖ Conteo finalizado. Revisa las diferencias.");
                mostrarDiferencias(data.diferencias);
            } else {
                alert(`‚ö†Ô∏è Error: ${data.mensaje}`);
            }
        } catch (error) {
            console.error("Error al finalizar conteo:", error);
        }
    }
    window.finalizarConteo = finalizarConteo;

    // üìã MOSTRAR DIFERENCIAS EN PANTALLA
    function mostrarDiferencias(diferencias) {
        console.log("üîç Datos recibidos en el frontend:", diferencias);
        listaConteo.innerHTML = "";
        let hayDiferencias = false;

        diferencias.forEach(({ codigo, mensaje, en_base_datos = 0, escaneado = 0, diferencia = 0 }) => {
            const li = document.createElement("li");

            // Verificar si hay diferencia y asignar color
            const hayError = diferencia !== 0;
            const colorClase = hayError ? "bg-danger text-white" : "bg-success text-white";
            const mensajeFinal = hayError ? "‚ùå Diferencia detectada" : "‚úÖ Sin diferencias";

            li.className = `list-group-item d-flex justify-content-between align-items-center ${colorClase}`;
            li.innerHTML = `
            <span>üì¶ ${codigo} - ${mensajeFinal}</span>
            <span class="badge bg-light text-dark">${escaneado} / ${en_base_datos} (${diferencia})</span>`;

            listaConteo.appendChild(li);

            if (hayError) hayDiferencias = true;
        });

        // Mostrar el bot√≥n solo si hay diferencias
        const btnActualizar = document.getElementById('btnActualizarInventario');
        btnActualizar.style.display = hayDiferencias ? 'block' : 'none';

        // Almacenar diferencias globalmente para usarlas despu√©s
        window.diferencias = diferencias;
    }

    async function actualizarInventario() {
    try {
        const response = await fetch('/products/api/actualizar-inventario-nuevo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ diferencias: window.diferencias })
        });

        const data = await response.json();

        if (data.success) {
            // √âxito: mostrar mensaje bonito y recargar al cerrar
            Swal.fire({
                icon: 'success',
                title: '¬°Inventario actualizado!',
                text: data.mensaje,
                confirmButtonText: 'Aceptar',
                timer: 2000,
                timerProgressBar: true,
                willClose: () => {
                    location.reload();
                }
            });
        } else {
            // Advertencia o error de l√≥gica del servidor
            Swal.fire({
                icon: 'warning',
                title: 'Atenci√≥n',
                text: data.mensaje
            });
        }

        // Ocultar el bot√≥n de actualizaci√≥n
        document.getElementById('btnActualizarInventario').style.display = 'none';

    } catch (error) {
        console.error("Error al actualizar inventario:", error);
        Swal.fire({
            icon: 'error',
            title: 'Error de conexi√≥n',
            text: 'No se pudo actualizar el inventario.'
        });
    }
}
    window.actualizarInventario = actualizarInventario;
</script>